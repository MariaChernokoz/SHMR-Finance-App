//
//  CategoriesServise.swift
//  SHMR_Finance_App
//
//  Created by Chernokoz on 14.06.2025.
//

import Foundation

@MainActor
final class CategoriesService: ObservableObject {
    static let shared: CategoriesService = {
        let service = CategoriesService()
        return service
    }()

    private let localStore: CategoriesLocalStore

    private init() {
        do {
            let localStore = try SwiftDataCategoriesLocalStore()
            self.localStore = localStore
        } catch {
            assertionFailure("Failed to initialize CategoriesService storage: \(error)")
            fatalError("Critical: Unable to initialize CategoriesService storage")
        }
    }

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
    func getAllCategories() async throws -> [Category] {
        do {
            // Ð¡ÐµÑ‚ÐµÐ²Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹
            let categories = try await NetworkClient.shared.fetchDecodeData(endpointValue: "api/v1/categories", dataType: Category.self)
            
            // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð¾Ð± ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ
            AppNetworkStatus.shared.handleSuccessfulRequest()
            
            // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ð² Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ
            for category in categories {
                try await localStore.addCategory(category)
            }
            
            return categories
        } catch let error as NetworkError {
            print("âŒ Ð¡ÐµÑ‚ÐµÐ²Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹: \(error.userFriendlyMessage)")
            
            // Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÑÐµÐ¼ Ð¾ ÑÐµÑ‚ÐµÐ²Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ
            AppNetworkStatus.shared.handleNetworkError(error)
            
            // Ð•ÑÐ»Ð¸ ÑÐµÑ‚ÐµÐ²Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¸Ð· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°
            let localCategories = try await localStore.fetchAllCategories()
            
            // Ð•ÑÐ»Ð¸ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ñ‚Ð¾Ð¶Ðµ Ð¿ÑƒÑÑ‚Ð¾Ðµ, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
            if localCategories.isEmpty {
                print("ðŸ” Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸...")
                let testCategories = [
                    Category(id: 1, name: "ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹", emoji: "ðŸ›’", isIncome: false),
                    Category(id: 2, name: "Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚", emoji: "ðŸš—", isIncome: false),
                    Category(id: 3, name: "Ð Ð°Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ", emoji: "ðŸŽ®", isIncome: false),
                    Category(id: 4, name: "Ð—Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°", emoji: "ðŸ’°", isIncome: true),
                    Category(id: 5, name: "ÐŸÐ¾Ð´Ð°Ñ€ÐºÐ¸", emoji: "ðŸŽ", isIncome: true),
                    Category(id: 6, name: "Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ", emoji: "ðŸ¥", isIncome: false),
                    Category(id: 7, name: "ÐšÑ€Ð°ÑÐ¾Ñ‚Ð°", emoji: "ðŸ’„", isIncome: false),
                    Category(id: 8, name: "ÐžÐ±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ðµ", emoji: "ðŸ“š", isIncome: false),
                    Category(id: 9, name: "Ð¥Ð¾Ð±Ð±Ð¸", emoji: "ðŸŽ¨", isIncome: false),
                    Category(id: 10, name: "Ð”Ð¾Ð¼Ð°ÑˆÐ½Ð¸Ðµ Ð¶Ð¸Ð²Ð¾Ñ‚Ð½Ñ‹Ðµ", emoji: "ðŸ¾", isIncome: false),
                    Category(id: 11, name: "Ð ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ñ‹", emoji: "ðŸ½ï¸", isIncome: false)
                ]
                
                for category in testCategories {
                    try await localStore.addCategory(category)
                }
                
                return testCategories
            }
            
            return localCategories
        } catch {
            print("âŒ ÐÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹: \(error)")
            
            // Ð’ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð»ÑŽÐ±Ð¾Ð¹ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ñ‚Ð°ÐºÐ¶Ðµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¸Ð· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°
            let localCategories = try await localStore.fetchAllCategories()
            
            if localCategories.isEmpty {
                print("ðŸ” Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸...")
                let testCategories = [
                    Category(id: 1, name: "ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹", emoji: "ðŸ›’", isIncome: false),
                    Category(id: 2, name: "Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚", emoji: "ðŸš—", isIncome: false),
                    Category(id: 3, name: "Ð Ð°Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ", emoji: "ðŸŽ®", isIncome: false),
                    Category(id: 4, name: "Ð—Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°", emoji: "ðŸ’°", isIncome: true),
                    Category(id: 5, name: "ÐŸÐ¾Ð´Ð°Ñ€ÐºÐ¸", emoji: "ðŸŽ", isIncome: true),
                    Category(id: 6, name: "Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ", emoji: "ðŸ¥", isIncome: false),
                    Category(id: 7, name: "ÐšÑ€Ð°ÑÐ¾Ñ‚Ð°", emoji: "ðŸ’„", isIncome: false),
                    Category(id: 8, name: "ÐžÐ±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ðµ", emoji: "ðŸ“š", isIncome: false),
                    Category(id: 9, name: "Ð¥Ð¾Ð±Ð±Ð¸", emoji: "ðŸŽ¨", isIncome: false),
                    Category(id: 10, name: "Ð”Ð¾Ð¼Ð°ÑˆÐ½Ð¸Ðµ Ð¶Ð¸Ð²Ð¾Ñ‚Ð½Ñ‹Ðµ", emoji: "ðŸ¾", isIncome: false),
                    Category(id: 11, name: "Ð ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ñ‹", emoji: "ðŸ½ï¸", isIncome: false)
                ]
                
                for category in testCategories {
                    try await localStore.addCategory(category)
                }
                
                return testCategories
            }
            
            return localCategories
        }
    }

    // Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ/Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ
    func saveCategory(_ category: Category) async throws {
        do {
            // let request = ... // Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐµÑ‚ÐµÐ²Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ
            // try await NetworkClient.shared.request(...)
            try await localStore.updateCategory(category)
        } catch {
            try await localStore.updateCategory(category)
        }
    }

    // Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ
    func deleteCategory(by id: Int) async throws {
        do {
            // try await NetworkClient.shared.request(...)
            try await localStore.deleteCategory(by: id)
        } catch {
            try await localStore.deleteCategory(by: id)
        }
    }
    
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ Ð¿Ð¾ ID
    func getCategory(by id: Int) async throws -> Category? {
        let categories = try await getAllCategories()
        return categories.first { $0.id == id }
    }
}
